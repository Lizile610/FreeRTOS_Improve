# 11_队列怎么实现互斥访问



## 什么情况下需要引入队列

假设任务 A 和任务 B 都向任务 C 传递一个数值：

- A 和 B 将数值写入某个变量 `a`
- C 读变量 `a`

根据前面 [10_多任务系统中互斥的引入.md](10_多任务系统中互斥的引入.md) 中的解释，这样的通信方式是不安全的，A 和 B 操作变量 `a` 时都有可能会被对方打断，导致结果不符合预期。



## 队列怎么实现互斥

假设任务 A 和任务 B 写队列，任务 C 读这个队列

写队列函数中通过关中断来实现互斥：

```c
xQueueSend(...)
{
    // ...
    
    // 关中断
 
    // 写数据操作

    // 恢复中断
    
    // ...
}
```

关中断之后，当前任务不会被切换，除非写数据操作完成并恢复中断，这样就实现了互斥访问变量。



## 关于队列函数 “关闭中断”

1. “关中断” 关的是什么中断？
   - 写队列函数中，所谓的关中断，其实是关闭了某一类中断，其中包括了 Tick 中断，而任务调度/切换就依赖 Tick 中断
2. 关闭 Tick 中断后，系统能否运行？
   - 可以，关闭 Tick 中断不影响系统运行，只是暂时无法切换任务，关中断之前运行着的任务将会一直运行，直到恢复 Tick 中断
   - 关了中断之后，就相当于裸机程序